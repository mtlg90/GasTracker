<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GAS T. — Gas Tracker</title>

  <!-- Icons (assicurati di caricare i file in repository root) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
  <link rel="mask-icon" href="icon.svg" color="#7c3aed">
  <meta name="theme-color" content="#071023">

  <style>
    /* Modern dark UI */
    :root{
      --bg1:#071023; --bg2:#071428; --text:#e6eef8; --muted:#9ca3af;
      --accent1:#7c3aed; --accent2:#06b6d4; --glass:rgba(255,255,255,0.03);
      --radius:14px; --gap:14px; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:20px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo-box{display:flex;align-items:center;gap:12px}
    .logo-img{height:46px; width:auto; display:block}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap);margin-top:18px}
    .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.015));backdrop-filter: blur(6px);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .col-span-4{grid-column:span 4}
    .col-span-8{grid-column:span 8}
    label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;box-sizing:border-box}
    textarea{min-height:64px;resize:vertical}
    .row{display:flex;gap:10px}
    button{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px 14px;border-radius:12px;color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{flex:1;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));text-align:center;min-width:140px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:16px;font-weight:700;margin-top:6px}
    /* GRID 3x2 for stats */
    .stats-grid{display:grid;grid-template-columns: repeat(3, 1fr);grid-auto-rows: minmax(64px, auto);gap: 10px;margin-top: 12px;}
    @media(max-width:960px){ .stats-grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:760px){ .grid{grid-template-columns:1fr} .col-span-4,.col-span-8{grid-column:1} .stats-grid{grid-template-columns:1fr} }
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .chart-wrap{height:260px;padding:10px}
    .small{font-size:12px;color:var(--muted)}
    /* modal simple */
    .modal { position: fixed; left: 0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index:50; }
    .modal .card{max-width:520px; width:92%}
    /* touch improvements */
    button, input, textarea { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .muted-btn{background:transparent;border:1px dashed rgba(255,255,255,0.04);color:var(--muted)}
    .small-action{padding:6px 10px;border-radius:8px;font-size:13px}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand logo-box">
        <!-- image with fallback: if logo-text.svg missing fallback to PNG, otherwise show text -->
        <img id="logoImg" class="logo-img" src="logo-text.svg" alt="GAS T. — Gas Tracker" />
        <div>
          <h1 style="margin:0">GAS T.</h1>
          <div class="subtitle">Consumi • Previsioni • Storico</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportBtn" class="ghost small-action" title="Esporta CSV">Esporta CSV</button>
        <button id="importBtn" class="ghost small-action" title="Importa CSV">Importa CSV</button>
        <button id="saveBtn" class="small-action" title="Salva lettura">Salva</button>
      </div>
    </header>

    <div class="grid" role="main">
      <!-- Left: input -->
      <div class="card col-span-4" aria-labelledby="paramsTitle">
        <h3 id="paramsTitle">Parametri & nuova lettura</h3>

        <label>Prezzo materia prima (€/Smc)
          <input id="price_mp" type="number" step="0.0001" value="0.80" />
        </label>
        <label>Oneri fissi mensili (€)
          <input id="fixed_charge" type="number" step="0.01" value="10.00" />
        </label>

        <h4 style="margin-top:12px">Aggiungi / Modifica lettura</h4>
        <label>Data
          <input id="date" type="date" />
        </label>

        <div class="row" style="margin-top:6px">
          <div style="flex:1">
            <label>Lettura (Smc)
              <input id="reading" type="number" step="0.001" placeholder="es. 1234.567" />
            </label>
          </div>
          <div style="width:120px">
            <label>Ora
              <input id="time" type="time" />
            </label>
          </div>
        </div>

        <label>Temperatura minima (°C)
          <input id="temp" type="number" step="0.1" placeholder="es. 3.5" />
        </label>
        <label>Note (opzionale)
          <textarea id="notes" placeholder="es. weekend fuori casa"></textarea>
        </label>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="addBtn">Aggiungi</button>
          <button id="cancelEditBtn" class="ghost" style="display:none">Annulla</button>
          <button id="clearBtn" class="ghost">Cancella tutto</button>
        </div>

        <div id="message" class="small" style="margin-top:8px"></div>
      </div>

      <!-- Right: stats + chart + readings + monthly -->
      <div class="card col-span-8" aria-labelledby="statsTitle">
        <!-- TITLE centered -->
        <div style="text-align:center">
          <h3 id="statsTitle" style="margin:0">Statistiche & grafico</h3>
          <div class="small" style="margin-top:6px">Ultima lettura del giorno usata per calcoli</div>
        </div>

        <!-- STATS grid 3x2 -->
        <div class="stats-grid" aria-hidden="false">
          <div class="stat"><div class="label">Letture</div><div class="value" id="total">0</div></div>
          <div class="stat"><div class="label">Media/giorno (Smc)</div><div class="value" id="avgDaily">-</div></div>
          <div class="stat"><div class="label">Stima giornaliera (Smc)</div><div class="value" id="estDailySmc">-</div></div>

          <div class="stat"><div class="label">Stima settimanale (Smc)</div><div class="value" id="estWeeklySmc">-</div></div>
          <div class="stat"><div class="label">Stima 30gg (Smc)</div><div class="value" id="estMonthlySmc">-</div></div>
          <div class="stat"><div class="label">Costo stimato mensile (€)</div><div class="value" id="estMonthlyCost">-</div></div>
        </div>

        <div class="chart-wrap card" style="margin-top:12px">
          <canvas id="chart"></canvas>
        </div>

        <h4 style="margin-top:12px">Registro letture</h4>
        <table role="table" aria-label="Registro letture">
          <thead><tr><th>Data</th><th>Ora</th><th>Smc</th><th>Temp</th><th>Note</th><th>Azioni</th></tr></thead>
          <tbody id="readingsBody"></tbody>
        </table>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <div class="small">Consumo oggi (intra-day): <strong id="todayConsumption">-</strong></div>
          <div class="small">Stima giornaliera (€): <strong id="estDailyCost">-</strong></div>
          <div class="small">Stima settimanale (€): <strong id="estWeeklyCost">-</strong></div>
        </div>

        <h4 style="margin-top:14px">Consumo mensile (per mese)</h4>
        <table role="table" aria-label="Consumo mensile">
          <thead><tr><th>Mese</th><th>Consumo (Smc)</th><th>Media giornaliera (Smc/giorno)</th><th>Costo stimato (€)</th></tr></thead>
          <tbody id="monthlyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- hidden file input for import -->
  <input id="fileImport" type="file" accept=".csv,text/csv" style="display:none" />

<script>
/* ================== Firebase config (Realtime DB) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyCdY2xuLVTBmwUbs-sud5g6W-7eedoI1Qk",
  authDomain: "gastracker-a4bc5.firebaseapp.com",
  databaseURL: "https://gastracker-a4bc5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gastracker-a4bc5",
  storageBucket: "gastracker-a4bc5.firebasestorage.app",
  messagingSenderId: "523976617358",
  appId: "1:523976617358:web:1494df462f40813ec548df"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================== Utilities ================== */
let editingKey = null; // currently editing reading key
function showMessage(msg, type){
  const el = document.getElementById('message');
  el.textContent = msg || '';
  el.style.color = type === 'error' ? '#fca5a5' : (type === 'ok' ? '#86efac' : 'var(--muted)');
  if(msg) setTimeout(()=>{ if(el.textContent===msg) el.textContent=''; }, 3000);
}
function pad(n){ return String(n).padStart(2,'0'); }
function isoWithTime(dateStr, timeStr){
  if(!timeStr) timeStr = '00:00:00';
  if(timeStr.length===5) timeStr += ':00';
  return `${dateStr}T${timeStr}`;
}

/* ================== Chart init ================== */
let chart;
function initChart(){
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Smc (ultima lettura/giorno)', data: [], fill: true, tension: 0.3, backgroundColor: 'rgba(124,58,237,0.12)', borderColor: '#7c3aed', pointRadius: 3 }]},
    options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { display: true }, y: { display: true } } }
  });
}

/* ================== Core logic ================== */
function startEditing(key){
  // fetch reading and populate inputs
  db.ref('readings/' + key).once('value').then(snap=>{
    const r = snap.val();
    if(!r) return showMessage('Lettura non trovata', 'error');
    editingKey = key;
    // populate
    document.getElementById('date').value = r.date || '';
    const dt = r.datetime || '';
    document.getElementById('time').value = dt.slice(11,16) || '';
    document.getElementById('reading').value = r.reading;
    document.getElementById('temp').value = (typeof r.temperature !== 'undefined' && r.temperature !== null) ? r.temperature : '';
    document.getElementById('notes').value = r.notes || '';
    // store original timestamp in dataset on the add button (so we don't accidentally overwrite)
    document.getElementById('addBtn').dataset.origTimestamp = r.timestamp || '';
    // change UI
    document.getElementById('addBtn').textContent = 'Aggiorna';
    document.getElementById('cancelEditBtn').style.display = '';
    showMessage('Modifica in corso — apporta le modifiche e premi Aggiorna', 'ok');
  }).catch(e=> showMessage('Errore: '+e,'error'));
}

function cancelEdit(){
  editingKey = null;
  resetInput();
  document.getElementById('addBtn').textContent = 'Aggiungi';
  document.getElementById('cancelEditBtn').style.display = 'none';
  // clear stored original timestamp
  delete document.getElementById('addBtn').dataset.origTimestamp;
  showMessage('Modifica annullata', 'ok');
}

function resetInput(){
  const today = new Date(); document.getElementById('date').value = today.toISOString().slice(0,10);
  document.getElementById('reading').value = '';
  document.getElementById('time').value = '';
  document.getElementById('temp').value = '';
  document.getElementById('notes').value = '';
}

function addReading(){
  const date = document.getElementById('date').value;
  const readingRaw = document.getElementById('reading').value;
  const time = document.getElementById('time').value;
  const tempRaw = document.getElementById('temp').value;
  const notes = document.getElementById('notes').value || '';

  if(!date || readingRaw === '') { showMessage('Inserisci data e lettura', 'error'); return; }
  const reading = parseFloat(readingRaw);
  const temperature = tempRaw === '' ? null : parseFloat(tempRaw);
  const datetime = isoWithTime(date, time);

  if(editingKey){
    // update existing WITHOUT changing original timestamp
    const updates = {};
    updates['/readings/' + editingKey + '/date'] = date;
    updates['/readings/' + editingKey + '/datetime'] = datetime;
    updates['/readings/' + editingKey + '/reading'] = reading;
    updates['/readings/' + editingKey + '/temperature'] = temperature;
    updates['/readings/' + editingKey + '/notes'] = notes;
    // DO NOT overwrite timestamp. If you want to track update time, you could set updatedAt instead:
    // updates['/readings/' + editingKey + '/updatedAt'] = Date.now();
    db.ref().update(updates).then(()=>{
      showMessage('Lettura aggiornata', 'ok');
      editingKey = null;
      delete document.getElementById('addBtn').dataset.origTimestamp;
      document.getElementById('addBtn').textContent = 'Aggiungi';
      document.getElementById('cancelEditBtn').style.display = 'none';
      resetInput();
      loadAll();
    }).catch(err=> showMessage('Errore: '+err, 'error'));
    return;
  }

  // new reading
  const timestamp = Date.now();
  const newKey = db.ref('readings').push().key;
  const updates = {};
  updates['/readings/' + newKey] = { date, datetime, reading, temperature, notes, timestamp };
  // also persist settings
  updates['/settings/price_mp'] = parseFloat(document.getElementById('price_mp').value) || 0;
  updates['/settings/fixed_charge'] = parseFloat(document.getElementById('fixed_charge').value) || 0;

  db.ref().update(updates)
    .then(()=>{ showMessage('Lettura salvata', 'ok'); resetInput(); loadAll(); })
    .catch(err=> showMessage('Errore: '+err, 'error'));
}

function deleteReading(key){
  if(!confirm('Eliminare questa lettura?')) return;
  if(editingKey === key) cancelEdit();
  db.ref('readings/' + key).remove().then(()=>{ showMessage('Lettura eliminata','ok'); loadAll(); }).catch(e=>showMessage('Errore: '+e,'error'));
}

function clearAll(){
  if(!confirm('Cancellare tutte le letture?')) return;
  db.ref('readings').remove().then(()=>{ showMessage('Tutti i dati cancellati','ok'); loadAll(); }).catch(e=>showMessage('Errore: '+e,'error'));
}

function loadAll(){
  Promise.all([ db.ref('readings').once('value'), db.ref('settings').once('value') ])
    .then(([snapR, snapS])=>{
      const readingsObj = snapR.val() || {};
      const settings = snapS.val() || {};
      if(typeof settings.price_mp !== 'undefined') document.getElementById('price_mp').value = settings.price_mp;
      if(typeof settings.fixed_charge !== 'undefined') document.getElementById('fixed_charge').value = settings.fixed_charge;
      renderAll(readingsObj, settings);
    })
    .catch(err => showMessage('Errore caricamento: '+err,'error'));
}

/* ====== renderAll: supports intra-day totals, monthly aggregation and edit buttons ====== */
function renderAll(readingsObj, settings){
  // trasformo readingsObj in array con chiave
  const arr = Object.keys(readingsObj).map(k => ({ key: k, ...readingsObj[k] }));
  // ordino per timestamp asc (vecchie prima)
  arr.sort((a,b)=> (Number(a.timestamp||0)) - (Number(b.timestamp||0)));

  // render tabella (mostro le più recenti in cima)
  const tbody = document.getElementById('readingsBody');
  tbody.innerHTML = '';
  arr.slice().reverse().forEach(r=>{
    const time = (r.datetime || '').slice(11,19) || '-';
    const tr = document.createElement('tr');
    // actions: edit + delete
    tr.innerHTML = `<td>${r.date}</td><td>${time}</td><td>${Number(r.reading).toFixed(3)}</td><td>${r.temperature!==null && typeof r.temperature!=='undefined' ? r.temperature : '-'}</td><td>${(r.notes||'')}</td>
      <td>
        <button class="small-action muted-btn" onclick="startEditing('${r.key}')">Modifica</button>
        <button class="small-action ghost" onclick="deleteReading('${r.key}')">Elimina</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // gruppo letture per data in array ordinati
  const byDateArrays = {}; // date => [records asc by timestamp]
  arr.forEach(r=>{
    if(!byDateArrays[r.date]) byDateArrays[r.date] = [];
    byDateArrays[r.date].push(r);
  });

  // ottengo lastPerDay (ultima lettura del giorno) e firstPerDay (prima lettura del giorno)
  const dates = Object.keys(byDateArrays).sort(); // asc
  const lastPerDay = [];
  const firstPerDay = [];
  dates.forEach(d=>{
    const list = byDateArrays[d]; // asc
    if(list && list.length){
      firstPerDay.push({ date: d, reading: Number(list[0].reading), timestamp: list[0].timestamp });
      lastPerDay.push({ date: d, reading: Number(list[list.length-1].reading), timestamp: list[list.length-1].timestamp });
    }
  });

  // calcolo totali giornalieri (quando possibile) come last - first per lo stesso giorno
  const dailyTotals = []; // {date, total}
  dates.forEach(d=>{
    const list = byDateArrays[d];
    if(list && list.length >= 2){
      const total = Number(list[list.length-1].reading) - Number(list[0].reading);
      if(!isNaN(total) && total >= 0) dailyTotals.push({ date: d, total });
    }
  });

  // diffs tra giornate sulla base di lastPerDay
  const dayDiffs = [];
  for(let i=1;i<lastPerDay.length;i++){
    const diff = Number(lastPerDay[i].reading) - Number(lastPerDay[i-1].reading);
    if(!isNaN(diff) && diff >= 0) dayDiffs.push(diff);
  }

  // media giornaliera logica fallback
  let avgDaily = null;
  if(dayDiffs.length > 0){
    avgDaily = dayDiffs.reduce((a,b)=>a+b,0) / dayDiffs.length;
  } else if(dailyTotals.length > 0){
    avgDaily = dailyTotals.reduce((a,b)=>a+b.total,0) / dailyTotals.length;
  } else {
    avgDaily = null;
  }

  // calcolo stime
  const today = new Date().toISOString().slice(0,10);
  const listToday = byDateArrays[today] || [];
  const todayIntra = (listToday.length >= 2) ? (Number(listToday[listToday.length-1].reading) - Number(listToday[0].reading)) : null;

  const estDailySmc = avgDaily !== null ? avgDaily : (todayIntra !== null ? todayIntra : null);
  const estWeeklySmc = estDailySmc !== null ? estDailySmc * 7 : null;
  const estMonthly = estDailySmc !== null ? estDailySmc * 30 : null;

  const priceMp = (settings && settings.price_mp) ? settings.price_mp : parseFloat(document.getElementById('price_mp').value) || 0;
  const fixedCharge = (settings && settings.fixed_charge) ? settings.fixed_charge : parseFloat(document.getElementById('fixed_charge').value) || 0;
  const fixedPerDay = fixedCharge / 30;

  const estDailyCost = estDailySmc !== null ? (estDailySmc * priceMp + fixedPerDay) : null;
  const estWeeklyCost = estWeeklySmc !== null ? (estWeeklySmc * priceMp + fixedPerDay * 7) : null;
  const estMonthlyCost = estMonthly !== null ? (estMonthly * priceMp + fixedCharge) : null;

  // aggiorno DOM con valori (gestisco i casi null)
  document.getElementById('total').textContent = dates.length;
  document.getElementById('avgDaily').textContent = avgDaily !== null ? avgDaily.toFixed(3) + ' Smc/g' : '-';
  document.getElementById('estDailySmc').textContent = estDailySmc !== null ? estDailySmc.toFixed(3) + ' Smc' : '-';
  document.getElementById('estWeeklySmc').textContent = estWeeklySmc !== null ? estWeeklySmc.toFixed(3) + ' Smc' : '-';
  document.getElementById('estMonthlySmc').textContent = estMonthly !== null ? estMonthly.toFixed(1) + ' Smc' : '-';
  document.getElementById('estMonthlyCost').textContent = estMonthlyCost !== null ? estMonthlyCost.toFixed(2) + ' €' : '-';
  document.getElementById('estDailyCost').textContent = estDailyCost !== null ? estDailyCost.toFixed(2) + ' €' : '-';
  document.getElementById('estWeeklyCost').textContent = estWeeklyCost !== null ? estWeeklyCost.toFixed(2) + ' €' : '-';
  document.getElementById('todayConsumption').textContent = todayIntra !== null ? (todayIntra.toFixed(3) + ' Smc') : '-';

  // Aggiorno il chart: uso lastPerDay (etichette: date, valori: last reading)
  const chartLabels = lastPerDay.map(x => x.date);
  const chartData = lastPerDay.map(x => Number(x.reading));
  updateChart(chartLabels, chartData);

  // =========================
  // Calcolo consumo mensile + media giornaliera (consumo / giorni_del_mese)
  // =========================
  const byMonth = {}; // ym -> {min, max, countDates, datesSet}
  arr.forEach(r=>{
    const ym = (r.date || '').slice(0,7); // 'YYYY-MM'
    if(!ym) return;
    const val = Number(r.reading);
    if(isNaN(val)) return;
    if(!byMonth[ym]) byMonth[ym] = { min: val, max: val, dates: new Set() };
    if(val < byMonth[ym].min) byMonth[ym].min = val;
    if(val > byMonth[ym].max) byMonth[ym].max = val;
    // count unique dates present (not necessarily all days of month)
    byMonth[ym].dates.add(r.date);
  });

  // render monthly table sorted desc (recenti prima)
  const months = Object.keys(byMonth).sort().reverse();
  const monthlyBody = document.getElementById('monthlyBody');
  monthlyBody.innerHTML = '';
  months.forEach(m=>{
    const obj = byMonth[m];
    let consumption = null;
    if(typeof obj.min !== 'undefined' && typeof obj.max !== 'undefined' && obj.max >= obj.min){
      consumption = obj.max - obj.min;
    }
    // days in month for calendar average
    const [y, mm] = m.split('-').map(Number);
    const daysInMonth = new Date(y, mm, 0).getDate();
    const avgPerCalendarDay = consumption !== null ? (consumption / daysInMonth) : null;
    // optional: average per recorded day:
    const recordedDays = obj.dates.size || 0;
    const avgPerRecordedDay = (consumption !== null && recordedDays>0) ? (consumption / recordedDays) : null;

    const cost = (consumption !== null) ? (consumption * priceMp + fixedCharge) : null;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m}</td>
      <td>${consumption !== null ? consumption.toFixed(3) + ' Smc' : '-'}</td>
      <td>${avgPerCalendarDay !== null ? avgPerCalendarDay.toFixed(3) + ' Smc/g' : '-'}</td>
      <td>${cost !== null ? cost.toFixed(2) + ' €' : '-'}</td>`;
    monthlyBody.appendChild(tr);
  });
}

/* ================== Chart update ================== */
function updateChart(labels, data){
  if(!chart) return;
  if(!labels || labels.length === 0){ chart.data.labels = []; chart.data.datasets[0].data = []; chart.update(); return; }
  chart.data.labels = labels;
  chart.data.datasets[0].data = data;
  chart.update();
}

/* ================== Export / Import CSV ================== */
function exportCsv(){
  db.ref('readings').once('value').then(snap=>{
    const obj = snap.val() || {};
    const rows = [['key','date','datetime','reading','temperature','notes','timestamp']];
    Object.keys(obj).forEach(k=>{
      const r = obj[k];
      rows.push([k, r.date || '', r.datetime || '', r.reading || '', r.temperature || '', (r.notes||'').replace(/"/g,'""'), r.timestamp || '']);
    });
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'gas_readings.csv'; a.click();
    URL.revokeObjectURL(url);
  });
}

function importCsvHandler(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
    if(lines.length<=1){ showMessage('CSV vuoto o non valido', 'error'); return; }
    // skip header
    const dataLines = lines.slice(1);
    const updates = {};
    dataLines.forEach(line=>{
      const cols = splitCsvLine(line);
      if(cols.length < 6) return;
      const key = cols[0] || db.ref('readings').push().key;
      updates['/readings/' + key] = {
        date: cols[1],
        datetime: cols[2],
        reading: parseFloat(cols[3]) || 0,
        temperature: cols[4] === '' ? null : parseFloat(cols[4]),
        notes: cols[5] || '',
        timestamp: cols[6] ? Number(cols[6]) : Date.now()
      };
    });
    if(Object.keys(updates).length === 0){ showMessage('Nessuna riga valida nel CSV', 'error'); return; }
    db.ref().update(updates).then(()=>{ showMessage('Import completato','ok'); loadAll(); }).catch(e=>showMessage('Errore import: '+e,'error'));
  };
  reader.readAsText(file);
}
function splitCsvLine(line){
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c === '"' ){ if(inQ && line[i+1] === '"'){ cur += '"'; i++; continue; } inQ = !inQ; continue; }
    if(c === ',' && !inQ){ res.push(cur); cur=''; continue; }
    cur += c;
  }
  res.push(cur);
  return res.map(s=>s.replace(/^"|"$/g,'').trim());
}

/* ================== Events & init ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // init chart
  initChart();
  // default date today
  const today = new Date(); document.getElementById('date').value = today.toISOString().slice(0,10);

  // logo fallback: try svg, else png, else text
  const logo = document.getElementById('logoImg');
  // if svg fails to load, fallback to png; if png fails create text node
  logo.addEventListener('error', ()=>{
    if(logo.src && logo.src.endsWith('.svg')){
      logo.src = 'icon-192.png';
    } else {
      // replace img with text
      const parent = logo.parentElement;
      parent.removeChild(logo);
      const span = document.createElement('div');
      span.style.fontWeight = '800';
      span.textContent = 'GAS T.';
      parent.insertBefore(span, parent.firstChild);
    }
  });

  // bind buttons (touch + click)
  const addBtn = document.getElementById('addBtn');
  addBtn.addEventListener('click', addReading);
  addBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); addReading(); });

  const cancelEditBtn = document.getElementById('cancelEditBtn');
  cancelEditBtn.addEventListener('click', cancelEdit);
  cancelEditBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); cancelEdit(); });

  const clearBtn = document.getElementById('clearBtn');
  clearBtn.addEventListener('click', clearAll);
  clearBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); clearAll(); });

  const saveBtn = document.getElementById('saveBtn');
  saveBtn.addEventListener('click', addReading);
  saveBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); addReading(); });

  const exportBtn = document.getElementById('exportBtn');
  exportBtn.addEventListener('click', exportCsv);
  exportBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); exportCsv(); });

  const importBtn = document.getElementById('importBtn');
  const fileInput = document.getElementById('fileImport');
  importBtn.addEventListener('click', ()=> fileInput.click());
  importBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); fileInput.click(); });

  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(f) importCsvHandler(f);
    fileInput.value = '';
  });

  // load initial data
  loadAll();
});
</script>
</body>
</html>